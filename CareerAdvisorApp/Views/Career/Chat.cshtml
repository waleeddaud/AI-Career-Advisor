@{
    ViewData["Title"] = "Career Advisor Chat";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    body {
        background-color: #8fbec2 !important;
    }
    
    /* Minimal custom styles - only what Bootstrap doesn't provide */
    .user-bubble {
        background-color: #8fbec2;
        color: white;
        border-radius: 1rem 1rem 0 1rem;
        max-width: 70%;
    }
    
    .ai-bubble {
        background-color: #e9ecef;
        color: #212529;
        border-radius: 1rem 1rem 1rem 0;
        max-width: 70%;
    }
    
    .chat-input {
        border-radius: 2rem;
    }
    
    .btn-send {
        background-color: #8fbec2;
        border-radius: 2rem;
    }
    
    .btn-send:hover:not(:disabled) {
        background-color: #78a9ad;
    }
</style>

<div class="container mt-5 mb-5" style="max-width: 900px; margin-bottom: 150px !important;">
    <div class="card shadow-lg border-0 rounded-4">
        <!-- Header -->
        <div class="card-header text-white fw-semibold p-4" 
             style="background: linear-gradient(135deg, #8fbec2 0%, #78a9ad 100%); border-radius: 1rem 1rem 0 0;">
            <i class="bi bi-chat-dots me-2"></i>AI Career Advisor - Live Chat
        </div>

        <!-- Chat Window -->
        <div id="chatWindow" class="bg-light p-4 overflow-auto" style="height: 450px;">
            <!-- Welcome Message -->
            <div class="d-flex justify-content-start mb-3">
                <div class="ai-bubble p-3">
                    <i class="bi bi-robot"></i> Hello! I'm your AI Career Advisor. Ask me anything about career planning, skills, jobs, or career transitions!
                </div>
            </div>

            @if(Model?.Messages != null){
                @foreach (var msg in Model.Messages)
                {
                    if (msg.IsUser)
                    {
                        <div class="d-flex justify-content-end mb-3">
                            <div class="user-bubble p-3 fw-normal">@msg.Text</div>
                        </div>
                    }
                    else
                    {
                        <div class="d-flex justify-content-start mb-3">
                            <div class="ai-bubble p-3 fw-normal">@msg.Text</div>
                        </div>
                    }
                }
            }
        </div>

        <!-- Footer / Input Area -->
        <div class="card-footer bg-white border-top p-4">
            <!-- Typing Indicator -->
            <div id="typingIndicator" class="text-muted mb-2 small" style="display: none;">
                <i class="bi bi-three-dots"></i> <em>AI is typing...</em>
            </div>
            
            <!-- Input Form -->
            <div class="d-flex gap-2">
                <input type="text" 
                       id="messageInput" 
                       class="form-control chat-input flex-grow-1 border-2 px-4 py-2" 
                       placeholder="Type your message..." 
                       autocomplete="off" />
                <button id="sendButton" 
                        class="btn btn-send text-white fw-semibold px-4 py-2 border-0">
                    <i class="bi bi-send me-1"></i>Send
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .withAutomaticReconnect()
            .build();

        let connectionId = null;
        let currentAiMessageBubble = null;

        // Helper: Scroll to bottom
        function scrollToBottom() {
            const chatWindow = document.getElementById("chatWindow");
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Helper: Add user message
        function addUserMessage(text) {
            const chatWindow = document.getElementById("chatWindow");
            
            const wrapper = document.createElement("div");
            wrapper.className = "d-flex justify-content-end mb-3";
            
            const bubble = document.createElement("div");
            bubble.className = "user-bubble p-3 fw-normal";
            bubble.textContent = text;
            
            wrapper.appendChild(bubble);
            chatWindow.appendChild(wrapper);
            scrollToBottom();
        }

        // Helper: Start AI message
        function startAiMessage() {
            const chatWindow = document.getElementById("chatWindow");
            
            const wrapper = document.createElement("div");
            wrapper.className = "d-flex justify-content-start mb-3";
            
            const bubble = document.createElement("div");
            bubble.className = "ai-bubble p-3 fw-normal";
            bubble.textContent = "";
            
            wrapper.appendChild(bubble);
            chatWindow.appendChild(wrapper);
            currentAiMessageBubble = bubble;
            scrollToBottom();
        }

        // Helper: Add error message
        function addErrorMessage(error) {
            const chatWindow = document.getElementById("chatWindow");
            
            const wrapper = document.createElement("div");
            wrapper.className = "d-flex justify-content-start mb-3";
            
            const bubble = document.createElement("div");
            bubble.className = "bg-danger text-white p-3 rounded-3";
            bubble.style.maxWidth = "70%";
            bubble.innerHTML = `<i class="bi bi-exclamation-triangle me-1"></i> ${error}`;
            
            wrapper.appendChild(bubble);
            chatWindow.appendChild(wrapper);
            scrollToBottom();
        }

        // SignalR: Receive token
        connection.on("ReceiveToken", function (token) {
            if (!currentAiMessageBubble) {
                startAiMessage();
            }
            currentAiMessageBubble.textContent += token;
            scrollToBottom();
        });

        // SignalR: Stream complete
        connection.on("StreamComplete", function () {
            currentAiMessageBubble = null;
            document.getElementById("typingIndicator").style.display = "none";
            document.getElementById("sendButton").disabled = false;
            document.getElementById("messageInput").disabled = false;
            document.getElementById("messageInput").focus();
        });

        // SignalR: Error
        connection.on("ReceiveError", function (error) {
            addErrorMessage(error);
            currentAiMessageBubble = null;
            document.getElementById("typingIndicator").style.display = "none";
            document.getElementById("sendButton").disabled = false;
            document.getElementById("messageInput").disabled = false;
        });

        // Start connection
        connection.start()
            .then(function () {
                connectionId = connection.connectionId;
                console.log("✅ SignalR Connected. ID:", connectionId);
            })
            .catch(function (err) {
                console.error("❌ Connection Error:", err);
                addErrorMessage("Failed to connect. Please refresh the page.");
            });

        // Send message
        function sendMessage() {
            const messageInput = document.getElementById("messageInput");
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            if (!connectionId) {
                addErrorMessage("Not connected. Please refresh.");
                return;
            }

            addUserMessage(message);
            messageInput.value = "";
            
            document.getElementById("sendButton").disabled = true;
            messageInput.disabled = true;
            document.getElementById("typingIndicator").style.display = "block";

            fetch("/Career/SendChatMessage", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: message,
                    connectionId: connectionId
                })
            })
            .then(response => {
                if (!response.ok) throw new Error("Server error");
                return response.json();
            })
            .catch(error => {
                console.error("Error:", error);
                addErrorMessage("Failed to send. Please try again.");
                document.getElementById("typingIndicator").style.display = "none";
                document.getElementById("sendButton").disabled = false;
                messageInput.disabled = false;
            });
        }

        // Event listeners
        document.getElementById("sendButton").addEventListener("click", sendMessage);
        document.getElementById("messageInput").addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                e.preventDefault();
                sendMessage();
            }
        });

        // Reconnection handlers
        connection.onreconnecting(() => {
            console.log(" Reconnecting...");
        });

        connection.onreconnected(() => {
            console.log(" Reconnected!");
            connectionId = connection.connectionId;
        });
    </script>
}